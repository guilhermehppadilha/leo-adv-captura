---
// src/components/CtaForm.astro
---

<section class="bg-slate-900 py-24 sm:py-32">
  <div class="mx-auto max-w-xl px-6 lg:px-8 text-center" x-data="formHandler">
    <h2 class="text-3xl font-bold tracking-tight text-white sm:text-4xl">
      Desbloqueie sua conta agora!
    </h2>
    <p class="mt-4 text-lg leading-8 text-slate-300">
      Receba ajuda especializada em 24 horas.
    </p>

    <form @submit.prevent="submitForm" class="mx-auto mt-10 flex max-w-md flex-col gap-y-4">
      <input type="hidden" name="access_key" x-model="access_key">
      
      <div>
        <label for="email" class="block text-sm font-semibold leading-6 text-white text-left">Seu email</label>
        <div class="mt-2">
          <input type="email" name="email" id="email" x-model="formData.email" required class="block w-full rounded-md border-0 bg-white/5 p-3 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" placeholder="Digite seu email aqui">
        </div>
      </div>
      <div>
        <label for="telefone" class="block text-sm font-semibold leading-6 text-white text-left">Seu telefone (com DDD)</label>
        <div class="mt-2">
          <input type="tel" name="telefone" id="telefone" x-model="formData.telefone" required class="block w-full rounded-md border-0 bg-white/5 p-3 text-white shadow-sm ring-1 ring-inset ring-white/10 focus:ring-2 focus:ring-inset focus:ring-indigo-500 sm:text-sm sm:leading-6" placeholder="(XX) XXXXX-XXXX">
        </div>
      </div>

      <div x-show="successMessage" class="rounded-md bg-green-50 p-4 mt-4">
        <p class="text-sm font-medium text-green-800" x-text="successMessage"></p>
      </div>
      <div x-show="errorMessage" class="rounded-md bg-red-50 p-4 mt-4">
        <p class="text-sm font-medium text-red-800" x-text="errorMessage"></p>
      </div>

      <div class="mt-6">
        <button type="submit" :disabled="submitting" class="flex w-full justify-center rounded-md bg-indigo-500 px-3 py-3 text-sm font-semibold text-white shadow-sm hover:bg-indigo-400 disabled:opacity-50 disabled:cursor-not-allowed">
          <span x-show="!submitting">Enviar solicitação</span>
          <span x-show="submitting">Enviando...</span>
        </button>
      </div>
    </form>
  </div>
</section>

<script>
import Alpine from "alpinejs";

  document.addEventListener('alpine:init', () => {
    Alpine.data('formHandler', () => ({

      access_key: '1ae73361-39ac-4b06-8dfb-cee523b43fa9',

      whatsappLink: 'https://wa.me/5544998459187?text=Olá,Teste.',

      formData: {
        email: '',
        telefone: '',
        subject: 'Novo Contato no Formulário de Desbloqueio de Conta',
      },
      submitting: false,
      successMessage: '',
      errorMessage: '',
      
      async submitForm() {
        this.submitting = true;
        this.successMessage = '';
        this.errorMessage = '';

        const dataToSend = {
          ...this.formData,
          access_key: this.access_key,
        };

        try {
          const response = await fetch('https://api.web3forms.com/submit', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
            },
            body: JSON.stringify(dataToSend),
          });

          const result = await response.json();

          if (result.success) {
            this.successMessage = 'Dados enviados com sucesso! Redirecionando para o WhatsApp...';
            setTimeout(() => {
              window.open(this.whatsappLink, '_blank');
            }, 2000);
          } else {
            throw new Error(result.message || 'Houve um problema ao enviar os dados.');
          }
        } catch (error) {
          this.errorMessage = 'Ocorreu um erro. Por favor, tente novamente mais tarde.';
          console.error(error);
        } finally {
          this.submitting = false;
        }
      },
    }));
  });
</script>